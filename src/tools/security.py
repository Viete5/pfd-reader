import re
import logging
from typing import List

#  –û—á–∏—Å—Ç–∫–∞ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∫ –æ–ø–µ—á–∞—Ç–∫–∞–º –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º.
def _normalize_query(query: str) -> str:
    # 1. –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
    query = query.lower()

    # 2. –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–∏–º–≤–æ–ª–æ–≤ –ø—É–Ω–∫—Ç—É–∞—Ü–∏–∏ –∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤, –∫—Ä–æ–º–µ –ø—Ä–æ–±–µ–ª–æ–≤
    query = re.sub(r'[^\w\s]', ' ', query)

    # 3. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–±–µ–ª–æ–≤ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã -> –æ–¥–∏–Ω)
    query = re.sub(r'\s+', ' ', query).strip()

    # 4. –ó–∞–º–µ–Ω–∞ –ø–æ—Ö–æ–∂–∏—Ö –ª–∞—Ç–∏–Ω—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ —Ä—É—Å—Å–∫–∏–µ (–±–∞–∑–æ–≤–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç Homoglyph)
    homoglyphs = {
        ord('a'): '–∞', ord('e'): '–µ', ord('o'): '–æ', ord('i'): '—ñ',
        ord('c'): '—Å', ord('y'): '—É', ord('x'): '—Ö'
    }
    query = query.translate(homoglyphs)

    return query



logger = logging.getLogger(__name__)

# –§–∏–ª—å—Ç—Ä—É–µ—Ç –≤—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å, –±–ª–æ–∫–∏—Ä—É—è –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã Prompt Injection
# –∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (–∑–∞—â–∏—Ç–∞ –æ—Ç DoS).
def filter_input_query(query: str) -> str:

    query_lower = _normalize_query(query)

    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—ã—Ç–∞—é—Ç—Å—è –∏–∑–º–µ–Ω–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ LLM
    injection_patterns: List[str] = [
        # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
        r'–∏–≥–Ω–æ—Ä–∏—Ä—É–π.*–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏',
        r'–∑–∞–±—É–¥—å.*–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏',
        r'—Ç–µ–ø–µ—Ä—å\s+—Ç—ã.*–∫–∞–∫\s+',
        r'now\s+act\s+as',

        # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —É—Ç–µ—á–∫–∏ –ø—Ä–æ–º–ø—Ç–∞
        r'—Ä–∞—Å–∫—Ä–æ–π.*–ø—Ä–æ–º—Ç',
        r'–≤—ã–≤–µ–¥–∏.*–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏',
    ]

    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞—Ç–∞–∫—É Prompt Injection
    if any(re.search(pattern, query_lower) for pattern in injection_patterns):
        logger.warning(f"üö® –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∞—Ç–∞–∫–∞ 'Prompt Injection' –æ—Ç: {query}")
        return "" # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞

    # 2. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã (–ü—Ä–æ—Å—Ç–∞—è DoS-–∑–∞—â–∏—Ç–∞)
    MAX_QUERY_LENGTH = 1000
    if len(query) > MAX_QUERY_LENGTH:
        logger.warning(f"üö® –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å (Length: {len(query)})")
        return ""

    return query


import re


def moderate_output_response(response: str) -> str:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—Ç–≤–µ—Ç LLM –Ω–∞ –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
    —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –∏ –≥–∏–±–∫–æ–≥–æ —Å–ø–∏—Å–∫–∞ —Å—Ç–æ–ø-—Å–ª–æ–≤ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–∏—Å—Ç—ã–π –æ—Ç–≤–µ—Ç –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ.
    """
    response_lower = response.lower()

    # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    unsafe_keywords: List[str] = [
        # 1. –ù–∞—Å–∏–ª–∏–µ, –¢–µ—Ä—Ä–æ—Ä–∏–∑–º, –ü—Ä–µ—Å—Ç—É–ø–Ω–æ—Å—Ç—å (–ò—Å–ø–æ–ª—å–∑—É–µ–º \b –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏)
        r'\b—É–±–∏—Ç—å\b',
        r'\b–ø—ã—Ç–∞—Ç—å\b',
        r'\b–Ω–∞—Å–∏–ª–∏[—è–µ–∏]\b',
        r'\b–≤–∑–ª–æ–º[–∞—É]?\b',  # –†–∞–∑—Ä–µ—à–∞–µ–º '–≤–∑–ª–æ–º' –∏ '–≤–∑–ª–æ–º–∞—Ç—å'
        r'\b–º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤[–æ–∞]?\b',
        r'\b—ç–∫—Å—Ç—Ä–µ–º–∏–∑–º[–∞—É]?\b',
        r'\b—Ç–µ—Ä—Ä–æ—Ä[–∞—É]?\b',
        r'\b–±–æ–º–±[–∞—É]?\b',
        r'\b–Ω–µ–∑–∞–∫–æ–Ω–Ω[–∞–æ]?\b',

        # 2. –û–ø–∞—Å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã, –°–∞–º–æ–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ
        r'\b—Å–∞–º–æ—É–±–∏–π—Å—Ç–≤[–æ–∞]?\b',
        r'\b–Ω–∞–≤—Ä–µ–¥–∏—Ç—å\s+—Å–µ–±–µ\b',
        r'\b—è–¥[–∞—É]?\b',
        r'\b–Ω–∞—Ä–∫–æ—Ç–∏–∫[–∞—É]?\b',
        r'\b–æ—Ä—É–∂–∏[—è–µ]?\b',

        # –£—Ç–æ—á–Ω—è–µ–º –æ–ø–∞—Å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º .* –¥–æ 1-2 —Å–ª–æ–≤)
        r'–Ω–∞–Ω–µ—Å–µ–Ω–∏[–µ—è–∏]\s+–≤—Ä–µ–¥',  # –ù–∞–Ω–µ—Å–µ–Ω–∏–µ –≤—Ä–µ–¥–∞
        r'—Å–¥–µ–ª–∞—Ç—å\s+\w{1,2}\s+–±–æ–º–±—É',  # –°–¥–µ–ª–∞—Ç—å –•–• –±–æ–º–±—É
        r'–∏–∑–≥–æ—Ç–æ–≤–∏—Ç—å\s+\w{1,2}\s+–≤–∑—Ä—ã–≤—á–∞—Ç–∫[–∞—É]',
        r'–∫—É–ø–∏—Ç—å\s+\w{1,2}\s+–æ—Ä—É–∂–∏–µ',

        # 3. –û–±—Å—Ü–µ–Ω–Ω–∞—è –ª–µ–∫—Å–∏–∫–∞ (–æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ—Ä–Ω–∏ - —Ç—É—Ç —Å–ª–æ–∂–Ω–µ–µ —Å \b, –Ω–æ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å)
        r'\b–±–ª—è[–¥–¥—å–∏—è]\b', r'\b—Ö—É[–π—è–µ—é–∏]\b', r'\b–ø–∏[–∑–¥—Å–¥—Ü][–∞—ã–∏]\b',
        r'\b–µ–±[–∞–∏][—Ç—å—Ü–Ω]\b',
        r'\b–≥–æ–≤–Ω[–æ–∞–∏]\b',

        # 4. –ü–æ–ø—ã—Ç–∫–∏ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
        r'\b—Å–∏—Å—Ç–µ–º–Ω[–∞—ã]–π\s+–ø—Ä–æ–º—Ç\b',
        r'\b–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏[—è–∏]\s+–∞–≥–µ–Ω—Ç–∞\b',
        r'\b—Ä–∞—Å–∫—Ä—ã—Ç—å\s+–¥–∞–Ω–Ω—ã–µ\s+–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\b',

    ]

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
    if any(re.search(pattern, response_lower) for pattern in unsafe_keywords):
        logger.warning(f"üö® –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –æ—Ç–≤–µ—Ç, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç.")
        return "‚ùå –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–Ω—Ç–µ–Ω—Ç, –Ω–∞—Ä—É—à–∞—é—â–∏–π –ø–æ–ª–∏—Ç–∏–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å."

    return response
